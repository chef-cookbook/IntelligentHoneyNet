# Gets the MD5 and filename from malware found on the honeypot
# Currently handles the Cowrie ssh honeypot and Dionaea honeypot.
# Saves to /opt/malware_from_honeypots.txt. Logstash picks up that file and sends it to the server in /opt/files/incoming.
# Then, the python script: virustotal_api.py reads the file and looks up the MD5's. If any of the malware has been submitted to VT, then results are inserted into the database on the server.

#! /usr/bin/python
import os,hashlib

ssh_malware_dir = '/opt/cowrie/dl/'
dionaea_malware_dir = '/var/dionaea/bistreams/'
malware_info = '/opt/malware_from_honeypots.txt'

sshfilenames = []
dfilenames = []

def write_md5_and_files(line):
	writefile = open(malware_info,'a')
	writefile.write(line +'\n')
	writefile.close()

def load_file_list():
	global sshfilenames
	global dfilenames
	dfilenames = os.listdir(dionaea_malware_dir)
	sshfilenames = os.listdir(ssh_malware_dir)

def get_md5(dirname, fname):
    hash = hashlib.sha256()
    with open(dirname + fname) as f:
        for chunk in iter(lambda: f.read(4096), ""):
            hash.update(chunk)
    return hash.hexdigest()

load_file_list()

# ssh binaries:
for filename in sshfilenames:
	if filename != '.gitignore':
		md5 = get_md5(ssh_malware_dir,filename)
		line = filename + ',' + md5 + ',SSH'
                write_md5_and_files(line)

# Dionaea binaries:
for root, directories, filenames in os.walk(dionaea_malware_dir):
	for filename in filenames:
			malwaredir = root + '/'
			md5 = get_md5(malwaredir,filename)
			line = filename + ',' + md5 + ',Dionaea'
			write_md5_and_files(line)

os.system('rm -rf /var/dionaea/bistreams/*')